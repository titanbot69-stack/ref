document.addEventListener('DOMContentLoaded',function(){
	const modalEl = document.getElementById('adminRejectConfirmModal');
	const rejectIdSpan = document.getElementById('admin-reject-target-id');
	const confirmBtn = document.getElementById('admin-confirm-reject-btn');
	const ackBox = document.getElementById('admin-ack-reject-box');
	let pendingReject = null;
	let bsModal = null;
	if(modalEl){ bsModal = new bootstrap.Modal(modalEl); }
	ackBox && ackBox.addEventListener('change',()=>{ confirmBtn.disabled = !ackBox.checked; });

	function execute(row,eventId,action){
		fetch('/action/update-event-status/',{
			method:'POST',
			headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')},
			body: JSON.stringify({event_id:eventId,action})
		}).then(r=>r.json()).then(d=>{
			if(d.success){row.style.transition='opacity .5s';row.style.opacity=0;setTimeout(()=>row.remove(),500);}else{alert('Failed: '+(d.error||'Unknown'));}}
		).catch(()=>alert('Network error'));
	}

	document.querySelectorAll('.btn-action').forEach(btn=>{
		btn.addEventListener('click',function(){
			const row=this.closest('.request-item');
			if(!row)return; const eventId=row.dataset.eventId; const action=this.dataset.action;
			if(action==='reject'){
				pendingReject={row,eventId};
				rejectIdSpan.textContent=eventId;
				ackBox.checked=false; confirmBtn.disabled=true;
				bsModal && bsModal.show();
				return;
			}
			execute(row,eventId,action);
		});
	});

	confirmBtn && confirmBtn.addEventListener('click',function(){
		if(!pendingReject) return;
		const {row,eventId}=pendingReject;
		bsModal && bsModal.hide();
		execute(row,eventId,'reject');
		pendingReject=null;
	});
});
