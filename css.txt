    # Will fetch original request info (triggered_by etc.) for email notification
    original_triggered_by = None
    original_description = ''
    original_event_type = ''
    original_application = ''
    try:
        with connection.cursor() as cursor:
            cursor.execute(
                """
                SELECT triggered_by, event_description, event_type, application
                FROM event_status
                WHERE event_id = %s
                """,
                [event_id]
            )
            row = cursor.fetchone()
            if row:
                original_triggered_by, original_description, original_event_type, original_application = row
    except Exception as meta_err:
        logger.warning(f"Could not fetch original event for email meta (event {event_id}): {meta_err}")



        # Attempt to send final notification email to the RA (original requester)
        email_sent = False
        try:
            ra_email = (original_triggered_by or '').strip()
            if ra_email and '@' in ra_email:
                outcome_label = 'Completed' if action == 'mark-done' else 'Rejected'
                subject = f"Access Request {event_id} {outcome_label}"
                context = {
                    'event_id': event_id,
                    'outcome': outcome_label,
                    'description': original_description,
                    'performed_by': request.user.email,
                    'performed_at': assigned_at,
                    'application': original_application,
                    'event_type': original_event_type,
                }
                html_body = render(request, 'emails/final_request_outcome.html', context).content.decode('utf-8')
                text_body = (
                    f"Your access request (ID {event_id}) has been {outcome_label}.\n"
                    f"Application: {original_application or 'N/A'}\n"
                    f"Type: {original_event_type or 'N/A'}\n"
                    f"Description: {original_description or ''}\n"
                    f"Actioned By: {request.user.email} at {assigned_at.strftime('%Y-%m-%d %H:%M:%S')}"
                )
                try:
                    _send_email(subject, [ra_email], html_body, text_body)
                    email_sent = True
                except Exception as mail_err:
                    logger.error(f"Failed to send final outcome email for event {event_id}: {mail_err}")
        except Exception as notify_err:
            logger.error(f"Notification assembly failed for event {event_id}: {notify_err}")

        return JsonResponse({'success': True, 'email_sent': email_sent})


<div style="font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:1.5;color:#333;">
  <h3 style="margin-top:0;">Access Request Update</h3>
  <p style="margin:0 0 10px;">Hello,</p>
  <p style="margin:0 0 10px;">Your access request has reached a final decision from the Application Owner.</p>
  <table cellpadding="6" cellspacing="0" style="border-collapse:collapse;border:1px solid #ddd;font-size:13px;">
    <tr style="background:#f7f7f7;"><th align="left" style="border:1px solid #ddd;">Event ID</th><td style="border:1px solid #ddd;">{{ event_id }}</td></tr>
    <tr><th align="left" style="border:1px solid #ddd;">Outcome</th><td style="border:1px solid #ddd;">{{ outcome }}</td></tr>
    <tr><th align="left" style="border:1px solid #ddd;">Event Type</th><td style="border:1px solid #ddd;">{{ event_type }}</td></tr>
    <tr><th align="left" style="border:1px solid #ddd;">Application</th><td style="border:1px solid #ddd;">{{ application|default:'N/A' }}</td></tr>
    <tr><th align="left" style="border:1px solid #ddd;">Actioned By</th><td style="border:1px solid #ddd;">{{ performed_by }}</td></tr>
    <tr><th align="left" style="border:1px solid #ddd;">Actioned At</th><td style="border:1px solid #ddd;">{{ performed_at }}</td></tr>
  </table>
  <p style="margin:15px 0 5px;">Description:</p>
  <blockquote style="margin:0 0 15px;border-left:4px solid #ff8c1a;padding:6px 10px;background:#fff8f2;">{{ description }}</blockquote>
  <p style="font-size:12px;color:#777;margin:0;">This is an automated notification. No further action is required.</p>
</div>

